<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Date-IdeeÃ«n Generator (robuust)</title>
  <meta name="description" content="Genereer Nederlandse date-ideeÃ«n â€“ 100% client-side met transformers.js.">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>.kbd{border:1px solid #cbd5e1;border-bottom-width:3px;border-radius:.5rem;padding:.1rem .4rem;background:#fff}</style>
</head>
<body class="min-h-screen bg-rose-50 text-slate-900">
  <main class="max-w-xl mx-auto p-6">
    <h1 class="text-2xl font-bold mb-2">ðŸ’• Date-IdeeÃ«n Generator</h1>
    <p class="text-slate-600 mb-3">Gratis & zonder API-sleutel â€“ draait volledig in je browser. Eerste run laadt het model.</p>

    <div id="note" class="text-sm bg-amber-100 text-amber-800 border border-amber-200 rounded px-3 py-2 mb-3 hidden"></div>
    <div id="err" class="text-sm bg-red-100 text-red-800 border border-red-200 rounded px-3 py-2 mb-3 hidden"></div>

    <label class="block text-sm font-medium mb-1" for="thema">Thema (optioneel)</label>
    <input id="thema" class="w-full border rounded p-2 mb-3" placeholder="bijv. thuis, regenachtig, budget, verjaardag" />

    <div class="flex gap-3 mb-3">
      <button id="gen" class="px-4 py-2 rounded bg-rose-600 text-white hover:bg-rose-700">Genereer</button>
      <button id="copy" class="px-4 py-2 rounded border bg-white hover:shadow">ðŸ“‹ Kopieer</button>
      <button id="test" class="px-4 py-2 rounded border bg-white hover:shadow">ðŸ§ª Zelftest</button>
      <span class="text-xs text-slate-500 self-center">Tip: <span class="kbd">Ctrl</span>+<span class="kbd">Enter</span></span>
    </div>

    <label class="block text-sm font-medium mb-1" for="out">Resultaat</label>
    <textarea id="out" rows="14" class="w-full border rounded p-3 font-mono"></textarea>

    <p class="text-xs text-slate-500 mt-2">Model: <code>Xenova/t5-small</code> via <code>@xenova/transformers</code>.</p>
  </main>

  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';

    const $ = (id) => document.getElementById(id);
    const state = { pipe: null, salt: 0 };

    const setNote = (m) => { const n=$('note'); if(m){ n.textContent=m; n.classList.remove('hidden'); } else n.classList.add('hidden'); };
    const setErr  = (m) => { const e=$('err');  if(m){ e.textContent=m; e.classList.remove('hidden'); } else e.classList.add('hidden'); };

    async function getPipe() {
      if (state.pipe) return state.pipe;
      setErr('');
      setNote('Model ladenâ€¦ (eenmalig 20â€“60s)');
      try {
        state.pipe = await pipeline('text2text-generation', 'Xenova/t5-small', {
          progress_callback: (p) => { if (p.progress) setNote('Model ladenâ€¦ ' + Math.round(p.progress*100) + '%'); }
        });
        setNote('');
        return state.pipe;
      } catch (e) {
        console.error('Pipeline load error:', e);
        setNote('');
        setErr('Kon het model niet laden. Mogelijk blokkeert je netwerk cdn.jsdelivr.net of huggingface.co. Probeer privÃ©venster/ander netwerk.');
        throw e;
      }
    }

    // Stevige, Engelstalige instructie â†’ Nederlands output
    function buildPrompt(simple = false) {
      const thema = ($('thema').value || 'surprise').trim();
      state.salt = (state.salt + 1) % 1_000_000;

      if (simple) {
        return `Write a numbered list from 1 to 12 of short Dutch date ideas about: ${thema}. `
             + `Each item must be in Dutch, max 14 words. Vary indoor/outdoor/creative/active/relaxed. Avoid repetition. Output only the list.`;
      }

      return `You are a helpful writer. Create a numbered list (1â€“12) of short, original, low-budget DATE IDEAS in DUTCH about: ${thema}. `
           + `Each idea must be one concise Dutch sentence (max 16 words). Include variety (home/outdoor/creative/active/relaxed). Avoid repetition. `
           + `Write natural Dutch. Output ONLY the list, nothing else. Seed:${state.salt}`;
    }

    async function generateOnce(prompt) {
      const pipe = await getPipe();
      const res = await pipe(prompt, {
        max_new_tokens: 256,
        do_sample: true,
        top_p: 0.95,
        temperature: 0.9,
        repetition_penalty: 1.1,
        num_beams: 1,
        return_full_text: false
      });
      console.log('Raw model output â†’', res);
      return (res?.[0]?.generated_text || '').trim();
    }

    async function generate() {
      const btn = $('gen'), out = $('out');
      btn.disabled = true; btn.textContent = 'Bezigâ€¦'; setErr(''); out.value = '';

      try {
        // Poging 1 (instructie â†’ NL)
        let text = await generateOnce(buildPrompt(false));

        // Als leeg/te kort â†’ Poging 2 (eenvoudiger prompt)
        if (!text || text.length < 30) {
          text = await generateOnce(buildPrompt(true));
        }

        out.value = text || 'Geen output ontvangen. Probeer nogmaals, verander het thema, of test in een privÃ©venster.';
      } catch (e) {
        console.error('Generate error:', e);
        setErr('Er ging iets mis tijdens genereren. Mogelijk netwerkfilter/advertentieblokker. Zie console voor details.');
      } finally {
        btn.disabled = false; btn.textContent = 'Genereer';
      }
    }

    async function selfTest() {
      $('thema').value = 'thuis, regenachtig, budget';
      await generate();
    }

    async function copyOut() {
      const t = $('out');
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(t.value);
        } else { t.select(); document.execCommand('copy'); }
      } catch {}
    }

    window.addEventListener('load', () => {
      $('gen').addEventListener('click', generate);
      $('copy').addEventListener('click', copyOut);
      $('test').addEventListener('click', selfTest);
      document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generate(); });
    });
  </script>
</body>
</html>
