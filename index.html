<script type="module">
  import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.6.0';

  const $ = (id) => document.getElementById(id);
  const state = { pipe: null, salt: 0 };

  const setNote = (m) => { const n=$('note'); if(m){ n.textContent=m; n.classList.remove('hidden'); } else n.classList.add('hidden'); };
  const setErr  = (m) => { const e=$('err');  if(e){ if(m){ e.textContent=m; e.classList.remove('hidden'); } else e.classList.add('hidden'); } };

  async function getPipe() {
    if (state.pipe) return state.pipe;
    setErr('');
    setNote('Model laden… (eenmalig 20–60s)');
    // FLAN-T5 is beter voor instructies dan mT5
    state.pipe = await pipeline('text2text-generation', 'Xenova/flan-t5-small', {
      progress_callback: (p) => { if (p.progress) setNote('Model laden… ' + Math.round(p.progress*100) + '%'); }
    });
    setNote('');
    return state.pipe;
  }

  function buildPrompt(simple = false) {
    const thema = ($( 'thema').value || 'verrassing').trim();
    state.salt = (state.salt + 1) % 1_000_000;

    if (simple) {
      // Back-up prompt: nog explicieter en korter
      return `Write a numbered list (1-12) of short Dutch date ideas about: ${thema}. Each item max 14 words. Vary indoor/outdoor/creative/active/relaxed. Avoid repetition.`;
    }

    // Hoofdprompt voor NL
    return (
      'Schrijf in het Nederlands een genummerde lijst van 12 korte, originele en goedkope date-ideeën (1., 2., …). ' +
      'Gebruik natuurlijke, concrete zinnen van maximaal 16 woorden. Variatie: thuis/buiten/creatief/actief/relaxed. ' +
      'Vermijd herhaling. Thema: ' + thema + '. Zaad:' + state.salt + '.'
    );
  }

  async function generateOnce(prompt) {
    const pipe = await getPipe();
    const res = await pipe(prompt, {
      max_new_tokens: 256,
      do_sample: true,
      top_p: 0.95,
      temperature: 0.9,
      repetition_penalty: 1.1,
      num_beams: 1,
      // return_full_text is genegeerd voor seq2seq; opnemen schaadt niet
      return_full_text: false
    });
    return (res?.[0]?.generated_text || '').trim();
  }

  async function generate() {
    const btn = $('gen');
    const out = $('out');
    btn.disabled = true; btn.textContent = 'Bezig…';
    setErr(''); out.value = '';

    try {
      // 1e poging (NL prompt)
      let text = await generateOnce(buildPrompt(false));

      // Als leeg of te kort → 2e poging met simpelere EN-instructie
      if (!text || text.length < 30) {
        text = await generateOnce(buildPrompt(true));
      }

      out.value = text || 'Nog steeds geen output. Probeer een ander thema of ververs de pagina (cache).';
    } catch (e) {
      console.error('Generate error:', e);
      setErr('Er ging iets mis tijdens genereren. Mogelijk blokkeert je netwerk cdn.jsdelivr.net of huggingface.co.');
    } finally {
      btn.disabled = false; btn.textContent = 'Genereer';
    }
  }

  async function copyOut() {
    const t = $('out');
    try {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(t.value);
      } else { t.select(); document.execCommand('copy'); }
    } catch {}
  }

  window.addEventListener('load', () => {
    $('gen').addEventListener('click', generate);
    $('copy').addEventListener('click', copyOut);
    document.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') generate(); });
  });
</script>

